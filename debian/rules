#!/usr/bin/make -f
UPSTREAM_VERSION := $(shell cat browser/config/version.txt)
GRE_VERSION := 1.9.2
GRE_MILESTONE := $(shell config/milestone.pl --topsrcdir .|sed 's/[a-z]/~&/')

AUTOCONF_DIRS := ./nsprpub/build/autoconf/ ./build/autoconf/

LIB_DIR := /usr/lib/iceweasel
SHARE_DIR := /usr/share/iceweasel

CFLAGS := -g

CONFIGURE_OPTIONS = \
	--with-libxul-sdk=/usr/lib/xulrunner-devel-$(GRE_VERSION) \
	--with-user-appdir=.mozilla \
	--disable-installer \
	--disable-strip \
	--disable-install-strip \
	--disable-tests \
	--enable-extensions=default \
	--enable-single-profile \
	--disable-profilesharing \
	--enable-application=browser \
	--disable-updater \
	--disable-elf-dynstr-gc \
	--with-branding=debian/branding \
	--disable-necko-wifi \
	--disable-crashreporter

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CONFIGURE_OPTIONS += --disable-optimize
endif

ifneq (,$(findstring debug,$(DEB_BUILD_OPTIONS)))
	CONFIGURE_OPTIONS += --enable-debug
endif

IN_FILES := $(wildcard debian/*.in)
PREPROCESSED_FILES := $(IN_FILES:.in=)
$(PREPROCESSED_FILES): %: %.in
	sed -e 's/##GRE_VERSION##/$(GRE_VERSION)/g' -e 's/##GRE_MILESTONE##/$(GRE_MILESTONE)/g' $^ > $@

override_dh_auto_configure:
	for dir in $(AUTOCONF_DIRS); do \
		for file in config.guess config.sub; do \
			sed -i '2!b;/^#/ i\exec "/usr/share/misc/'$$file'" "$$@"' $$dir/$$file ; \
		done ; \
	done
	LDFLAGS="-Wl,--as-needed" \
	CFLAGS="$(CFLAGS)" \
	CXXFLAGS="$(CFLAGS) --std=gnu++0x" \
	dh_auto_configure -- $(CONFIGURE_OPTIONS)

override_dh_auto_clean:
	rm -f MPL $(filter-out debian/control,$(PREPROCESSED_FILES))
	dh_auto_clean

	for dir in $(AUTOCONF_DIRS); do \
		for file in config.guess config.sub; do \
			sed -i '2!b;/^exec "/ d' $$dir/$$file ; \
		done ; \
	done

override_dh_auto_install:
	dh_auto_install -- installdir=/usr/lib/iceweasel
	chmod 755 debian/iceweasel-xremote-client

override_dh_install:
	dh_install
#Install helpers
	install -m 755 debian/iceweasel-runner \
		debian/iceweasel/$(LIB_DIR)/iceweasel

# Install icons
	install -d -m 755 debian/iceweasel/usr/share/icons/hicolor/16x16/apps
	install -m 644 debian/branding/default16.png \
		debian/iceweasel/usr/share/icons/hicolor/16x16/apps/iceweasel.png
	install -d -m 755 debian/iceweasel/usr/share/icons/hicolor/32x32/apps
	install -m 644 debian/branding/default32.png \
		debian/iceweasel/usr/share/icons/hicolor/32x32/apps/iceweasel.png
	install -d -m 755 debian/iceweasel/usr/share/icons/hicolor/64x64/apps
	install -m 644 debian/branding/default64.png \
		debian/iceweasel/usr/share/icons/hicolor/64x64/apps/iceweasel.png
	install -d -m 755 debian/iceweasel/usr/share/icons/hicolor/scalable/apps
	install -m 644 debian/branding/iceweasel_icon.svg \
		debian/iceweasel/usr/share/icons/hicolor/scalable/apps/iceweasel.svg

# Remove unneeded configs
	rm -f debian/iceweasel/$(SHARE_DIR)/defaults/pref/firefox-l10n.js

# Install vendor preferences
	install -m 644 debian/vendor.js \
		debian/iceweasel/$(SHARE_DIR)/defaults/preferences/vendor.js

# Add Debian package version to preferences
	echo "pref(\"general.useragent.extra.firefoxComment\",\"(like Firefox/$(UPSTREAM_VERSION))\");" \
		>> debian/iceweasel/$(SHARE_DIR)/defaults/preferences/vendor.js

	sed -i 's/\(MinVersion=$(GRE_VERSION)\).*/\1/;s/\(MaxVersion=$(GRE_VERSION)\).*/\1.*/' debian/iceweasel/usr/lib/iceweasel/application.ini

MPL: LICENSE
	cp -f $< $@

override_dh_installdocs: MPL
	dh_installdocs -A MPL

override_dh_strip:
	dh_strip -a --dbg-package=iceweasel-dbg

override_dh_shlibdeps:
	dh_shlibdeps -a -l /usr/lib/xulrunner-$(GRE_VERSION)

install binary binary-arch binary-indep: $(PREPROCESSED_FILES)

binary binary-arch binary-indep build clean install:
	dh $@

.PHONY: build clean binary-indep binary-arch binary install
