From 4591dc4cb290a4ba5441c7d49e5642a6977dcc21 Mon Sep 17 00:00:00 2001
From: Mike Hommey <glandium@debian.org>
Date: Fri, 2 Apr 2010 10:01:52 +0200
Subject: [PATCH 40/40] Fix issues with symlinked component directories

https://bugzilla.mozilla.org/show_bug.cgi?id=551152
---
 .../xptinfo/src/xptiInterfaceInfoManager.cpp       |    7 ++++---
 1 files changed, 4 insertions(+), 3 deletions(-)

diff --git a/xpcom/reflect/xptinfo/src/xptiInterfaceInfoManager.cpp b/xpcom/reflect/xptinfo/src/xptiInterfaceInfoManager.cpp
index 57f6df9..f0d94b6 100644
--- a/xpcom/reflect/xptinfo/src/xptiInterfaceInfoManager.cpp
+++ b/xpcom/reflect/xptinfo/src/xptiInterfaceInfoManager.cpp
@@ -629,16 +629,17 @@ IndexOfDirectoryOfFile(nsISupportsArray* aSearchPath, nsILocalFile* aFile)
         NS_ASSERTION(count, "broken search path! bad count");
         for(PRUint32 i = 0; i < count; i++)
         {
-            nsCOMPtr<nsIFile> current;
+            nsCOMPtr<nsIFile> current, normalized;
             aSearchPath->QueryElementAt(i, NS_GET_IID(nsIFile), 
                                         getter_AddRefs(current));
             NS_ASSERTION(current, "broken search path! bad element");
             // nsIFile::Equals basically compares path strings so normalize
             // before the comparison.
             parent->Normalize();
-            current->Normalize();
+            current->Clone(getter_AddRefs(normalized));
+            normalized->Normalize();
             PRBool same;
-            if (NS_SUCCEEDED(parent->Equals(current, &same)) && same)
+            if (NS_SUCCEEDED(parent->Equals(normalized, &same)) && same)
                 return (int) i;
         }
     }
-- 
1.7.0.rc0.69.g2ee80

