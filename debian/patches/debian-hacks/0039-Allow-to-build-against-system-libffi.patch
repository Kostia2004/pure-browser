From a0ff71e99c2142cf0f43bbb528ab6676f459bf3a Mon Sep 17 00:00:00 2001
From: Mike Hommey <mh@glandium.org>
Date: Tue, 9 Mar 2010 09:44:37 +0100
Subject: [PATCH 39/40] Allow to build against system libffi

https://bugzilla.mozilla.org/show_bug.cgi?id=551138
---
 config/autoconf.mk.in            |    4 ++++
 config/system-headers            |    3 +++
 configure.in                     |   14 +++++++++++++-
 js/ctypes/Makefile.in            |    8 ++++++++
 js/src/config/system-headers     |    3 +++
 toolkit/library/libxul-config.mk |    3 +++
 toolkit/toolkit-tiers.mk         |    2 ++
 7 files changed, 36 insertions(+), 1 deletions(-)

diff --git a/config/autoconf.mk.in b/config/autoconf.mk.in
index 64a8e5b..791b78d 100644
--- a/config/autoconf.mk.in
+++ b/config/autoconf.mk.in
@@ -229,6 +229,10 @@ MOZ_NATIVE_HUNSPELL = @SYSTEM_HUNSPELL@
 MOZ_HUNSPELL_LIBS = @MOZ_HUNSPELL_LIBS@
 MOZ_HUNSPELL_CFLAGS = @MOZ_HUNSPELL_CFLAGS@
 
+MOZ_NATIVE_FFI = @MOZ_NATIVE_FFI@
+MOZ_FFI_LIBS = @MOZ_FFI_LIBS@
+MOZ_FFI_CFLAGS = @MOZ_FFI_CFLAGS@
+
 MOZ_NATIVE_ZLIB	= @SYSTEM_ZLIB@
 MOZ_NATIVE_BZ2	= @SYSTEM_BZ2@
 MOZ_NATIVE_JPEG	= @SYSTEM_JPEG@
diff --git a/config/system-headers b/config/system-headers
index 209fd19..f76b536 100644
--- a/config/system-headers
+++ b/config/system-headers
@@ -1017,3 +1017,6 @@ hildon-uri.h
 hildon-mime.h
 libosso.h
 #endif
+#if MOZ_NATIVE_FFI==1
+ffi.h
+#endif
diff --git a/configure.in b/configure.in
index 4bf8dba..f551a52 100644
--- a/configure.in
+++ b/configure.in
@@ -4474,6 +4474,18 @@ fi
 
 AC_SUBST(SYSTEM_HUNSPELL)
 
+dnl system libffi Support
+dnl ========================================================
+MOZ_ARG_ENABLE_BOOL(system-ffi,
+[  --enable-system-ffi       Use system libffi (located with pkgconfig)],
+    MOZ_NATIVE_FFI=1 )
+
+if test -n "$MOZ_NATIVE_FFI"; then
+    PKG_CHECK_MODULES(MOZ_FFI, libffi)
+fi
+
+AC_SUBST(MOZ_NATIVE_FFI)
+
 dnl ========================================================
 dnl Java SDK support
 dnl ========================================================
@@ -8600,7 +8612,7 @@ ac_configure_args="$_SUBDIR_CONFIG_ARGS"
 # Build jsctypes on the platforms we can.
 if test "$BUILD_CTYPES"; then
   # Run the libffi 'configure' script on platforms that it supports.
-  if test -z "$_MSC_VER"; then
+  if test -z "$MOZ_NATIVE_FFI" && test -z "$_MSC_VER"; then
     ac_configure_args="--disable-shared --enable-static --disable-raw-api"
     if test "$MOZ_DEBUG"; then
       ac_configure_args="$ac_configure_args --enable-debug"
diff --git a/js/ctypes/Makefile.in b/js/ctypes/Makefile.in
index 2ccd495..35e5253 100644
--- a/js/ctypes/Makefile.in
+++ b/js/ctypes/Makefile.in
@@ -95,18 +95,26 @@ endif
 else # _MSVC_VER
 
 # build libffi proper
+ifdef MOZ_NATIVE_FFI
+LOCAL_INCLUDES = $(MOZ_FFI_CFLAGS)
+else
 LOCAL_INCLUDES = \
     -Ilibffi/include \
     $(NULL)
+endif
 
 ifeq ($(OS_ARCH),OS2)
 libffi/.libs/ffi.$(LIB_SUFFIX): libffi/.libs/$(LIB_PREFIX)ffi.a
 	emxomf $<
 endif
 
+ifdef MOZ_NATIVE_FFI
+EXTRA_DSO_LDOPTS += $(MOZ_FFI_LIBS)
+else
 SHARED_LIBRARY_LIBS = \
     libffi/.libs/$(LIB_PREFIX)ffi.$(LIB_SUFFIX) \
     $(NULL)
+endif
 
 endif # _MSVC_VER
 
diff --git a/js/src/config/system-headers b/js/src/config/system-headers
index 209fd19..f76b536 100644
--- a/js/src/config/system-headers
+++ b/js/src/config/system-headers
@@ -1017,3 +1017,6 @@ hildon-uri.h
 hildon-mime.h
 libosso.h
 #endif
+#if MOZ_NATIVE_FFI==1
+ffi.h
+#endif
diff --git a/toolkit/library/libxul-config.mk b/toolkit/library/libxul-config.mk
index 89b8b3d..6cea1c0 100644
--- a/toolkit/library/libxul-config.mk
+++ b/toolkit/library/libxul-config.mk
@@ -142,6 +142,9 @@ ifdef BUILD_CTYPES
 COMPONENT_LIBS += \
 	jsctypes \
 	$(NULL)
+ifdef MOZ_NATIVE_FFI
+EXTRA_DSO_LDOPTS += $(MOZ_FFI_LIBS)
+endif
 endif
 
 ifdef MOZ_PLUGINS
diff --git a/toolkit/toolkit-tiers.mk b/toolkit/toolkit-tiers.mk
index 57985cc..ee1d280 100644
--- a/toolkit/toolkit-tiers.mk
+++ b/toolkit/toolkit-tiers.mk
@@ -88,12 +88,14 @@ tier_gecko_dirs += \
 		$(NULL)
 
 ifdef BUILD_CTYPES
+ifndef MOZ_NATIVE_FFI
 ifndef _MSC_VER
 tier_gecko_staticdirs += \
 		js/ctypes/libffi \
 		$(NULL)
 endif
 endif
+endif
 
 ifdef MOZ_ENABLE_GTK2
 ifdef MOZ_X11
-- 
1.7.0.rc0.69.g2ee80

