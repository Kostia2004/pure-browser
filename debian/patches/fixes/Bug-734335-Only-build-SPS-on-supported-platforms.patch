From: Mike Hommey <mh@glandium.org>
Date: Fri, 9 Mar 2012 09:46:25 +0100
Subject: Bug 734335 - Only build SPS on supported platforms

---
 configure.in                              |   31 +++++++++++++++++++++++++----
 toolkit/library/Makefile.in               |    2 ++
 toolkit/library/nsStaticXULComponents.cpp |    8 +++++++-
 tools/profiler/Makefile.in                |    8 +++++---
 tools/profiler/sampler.h                  |    2 +-
 5 files changed, 42 insertions(+), 9 deletions(-)

diff --git a/configure.in b/configure.in
index 9163897..b688692 100644
--- a/configure.in
+++ b/configure.in
@@ -2134,10 +2134,33 @@ fi
 dnl ========================================================
 dnl SPS Profiler
 dnl ========================================================
-MOZ_ARG_ENABLE_BOOL(sps,
-[  --enable-sps          Enable sps profiling tool.],
-    MOZ_ENABLE_PROFILER_SPS=1,
-    MOZ_ENABLE_PROFILER_SPS= )
+MOZ_ENABLE_PROFILER_SPS=1
+
+case "${OS_TARGET}" in
+Android)
+    case "${CPU_ARCH}" in
+    x86 | arm) ;;
+    *)
+        MOZ_ENABLE_PROFILER_SPS=
+    esac
+    ;;
+Linux)
+    case "${CPU_ARCH}" in
+    x86 | x86_64) ;;
+    *)
+        MOZ_ENABLE_PROFILER_SPS=
+    esac
+    ;;
+WINNT|Darwin) ;;
+*)
+    MOZ_ENABLE_PROFILER_SPS=
+    ;;
+esac
+
+MOZ_ARG_DISABLE_BOOL(sps,
+[  --disable-sps         Disable sps profiling tool.],
+    MOZ_ENABLE_PROFILER_SPS=,
+    MOZ_ENABLE_PROFILER_SPS=1)
 if test -n "$MOZ_ENABLE_PROFILER_SPS"; then
     AC_DEFINE(MOZ_ENABLE_PROFILER_SPS)
 fi
diff --git a/toolkit/library/Makefile.in b/toolkit/library/Makefile.in
index de8b643..f3ab749 100644
--- a/toolkit/library/Makefile.in
+++ b/toolkit/library/Makefile.in
@@ -315,7 +315,9 @@ endif
 
 STATIC_LIBS += thebes gl ycbcr
 
+ifdef MOZ_ENABLE_PROFILER_SPS
 COMPONENT_LIBS += profiler
+endif
 
 ifeq (windows,$(MOZ_WIDGET_TOOLKIT))
 COMPONENT_LIBS += widget_windows
diff --git a/toolkit/library/nsStaticXULComponents.cpp b/toolkit/library/nsStaticXULComponents.cpp
index e06951f..d5b6cd7 100644
--- a/toolkit/library/nsStaticXULComponents.cpp
+++ b/toolkit/library/nsStaticXULComponents.cpp
@@ -198,6 +198,12 @@
 #endif
 #endif
 
+#if defined(MOZ_ENABLE_PROFILER_SPS)
+#define PROFILER_MODULE MODULE(nsProfilerModule)
+#else
+#define PROFILER_MODULE
+#endif
+
 #define XUL_MODULES                          \
     MODULE(nsUConvModule)                    \
     MODULE(nsI18nModule)                     \
@@ -214,7 +220,7 @@
     MODULE(nsWindowDataSourceModule)         \
     MODULE(nsParserModule)                   \
     MODULE(nsGfxModule)                      \
-    MODULE(nsProfilerModule)                 \
+    PROFILER_MODULE                          \
     WIDGET_MODULES                           \
     MODULE(nsImageLib2Module)                \
     ICON_MODULE                              \
diff --git a/tools/profiler/Makefile.in b/tools/profiler/Makefile.in
index 1befb6b..e67f715 100644
--- a/tools/profiler/Makefile.in
+++ b/tools/profiler/Makefile.in
@@ -48,8 +48,10 @@ VPATH       = \
 
 include $(DEPTH)/config/autoconf.mk
 
-EXPORTS = \
-  sampler.h \
+EXPORTS =  sampler.h
+
+ifdef MOZ_ENABLE_PROFILER_SPS
+EXPORTS += \
   sps_sampler.h \
   thread_helper.h \
   $(NULL)
@@ -114,7 +116,7 @@ CPPSRCS += \
   $(NULL)
 endif
 
-
+endif
 
 include $(topsrcdir)/config/rules.mk
 
diff --git a/tools/profiler/sampler.h b/tools/profiler/sampler.h
index 752d9fa..4f7a03a 100644
--- a/tools/profiler/sampler.h
+++ b/tools/profiler/sampler.h
@@ -78,7 +78,7 @@
 #define SAMPLER_H
 
 // Redefine the macros for platforms where SPS is supported.
-#if defined(ANDROID) || defined(__linux__) || defined(XP_MACOSX) || defined(XP_WIN)
+#ifdef MOZ_ENABLE_PROFILER_SPS
 
 #include "sps_sampler.h"
 
