From: Mike Hommey <mh+mozilla@glandium.org>
Date: Tue, 9 Oct 2012 14:52:50 +0200
Subject: Bug 762833 - Fallback to the xulrunner subdirectory if webapprt
 can't find xpcom in firefox directory

---
 webapprt/gtk2/webapprt.cpp |   11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/webapprt/gtk2/webapprt.cpp b/webapprt/gtk2/webapprt.cpp
index 185808d..6b44df6 100644
--- a/webapprt/gtk2/webapprt.cpp
+++ b/webapprt/gtk2/webapprt.cpp
@@ -129,8 +129,11 @@ bool GRELoadAndLaunch(const char* firefoxDir, bool silentFail)
   char xpcomDllPath[MAXPATHLEN];
   snprintf(xpcomDllPath, MAXPATHLEN, "%s/%s", firefoxDir, XPCOM_DLL);
 
-  if (silentFail && access(xpcomDllPath, F_OK) != 0)
-    return false;
+  if (access(xpcomDllPath, F_OK) != 0) {
+    snprintf(xpcomDllPath, MAXPATHLEN, "%s/xulrunner/%s", firefoxDir, XPCOM_DLL);
+    if (silentFail && access(xpcomDllPath, F_OK) != 0)
+      return false;
+  }
 
   if (NS_FAILED(XPCOMGlueStartup(xpcomDllPath))) {
     ErrorDialog("Couldn't load the XPCOM library");
@@ -191,12 +194,12 @@ bool GRELoadAndLaunch(const char* firefoxDir, bool silentFail)
     }
 
     nsCOMPtr<nsIFile> xreDir;
-    if (NS_FAILED(XRE_GetFileFromPath(firefoxDir, getter_AddRefs(xreDir)))) {
+    if (NS_FAILED(XRE_GetFileFromPath(xpcomDllPath, getter_AddRefs(xreDir)))) {
       ErrorDialog("Couldn't open XRE directory");
       return false;
     }
 
-    xreDir.forget(&webShellAppData->xreDirectory);
+    xreDir->GetParent(&webShellAppData->xreDirectory);
     NS_IF_RELEASE(webShellAppData->directory);
     directory.forget(&webShellAppData->directory);
 
