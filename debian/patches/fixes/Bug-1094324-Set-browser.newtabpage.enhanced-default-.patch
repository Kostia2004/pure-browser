From: Mike Hommey <mh@glandium.org>
Date: Mon, 25 May 2015 10:50:01 +0900
Subject: Bug 1094324 - Set browser.newtabpage.enhanced default in prefs

---
 browser/app/profile/firefox.js             | 3 +++
 browser/base/content/newtab/intro.js       | 3 +++
 browser/base/content/newtab/page.js        | 1 +
 browser/modules/DirectoryLinksProvider.jsm | 2 +-
 4 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/browser/app/profile/firefox.js b/browser/app/profile/firefox.js
index 575b39c..fc4cb61 100644
--- a/browser/app/profile/firefox.js
+++ b/browser/app/profile/firefox.js
@@ -1692,6 +1692,9 @@ pref("browser.newtabpage.introShown", false);
 // Toggles the content of 'about:newtab'. Shows the grid when enabled.
 pref("browser.newtabpage.enabled", true);
 
+// Toggles the enhanced content of 'about:newtab'. Shows sponsored tiles.
+sticky_pref("browser.newtabpage.enhanced", true);
+
 // number of rows of newtab grid
 pref("browser.newtabpage.rows", 3);
 
diff --git a/browser/base/content/newtab/intro.js b/browser/base/content/newtab/intro.js
index f67e085..3c0620c 100644
--- a/browser/base/content/newtab/intro.js
+++ b/browser/base/content/newtab/intro.js
@@ -64,6 +64,9 @@ let gIntro = {
   },
 
   showIfNecessary: function() {
+    if (!Services.prefs.getBoolPref(PREF_NEWTAB_ENHANCED)) {
+      return;
+    }
     if (!Services.prefs.getBoolPref(PREF_INTRO_SHOWN)) {
       this.showPanel();
       Services.prefs.setBoolPref(PREF_INTRO_SHOWN, true);
diff --git a/browser/base/content/newtab/page.js b/browser/base/content/newtab/page.js
index 7c02289..4ba3fb1 100644
--- a/browser/base/content/newtab/page.js
+++ b/browser/base/content/newtab/page.js
@@ -54,6 +54,7 @@ let gPage = {
       // Update thumbnails to the new enhanced setting
       if (aData == "browser.newtabpage.enhanced") {
         this.update();
+        gIntro.showIfNecessary();
       }
 
       // Initialize the whole page if we haven't done that, yet.
diff --git a/browser/modules/DirectoryLinksProvider.jsm b/browser/modules/DirectoryLinksProvider.jsm
index 2e65073..70815bd 100644
--- a/browser/modules/DirectoryLinksProvider.jsm
+++ b/browser/modules/DirectoryLinksProvider.jsm
@@ -216,7 +216,7 @@ let DirectoryLinksProvider = {
    */
   _setDefaultEnhanced: function DirectoryLinksProvider_setDefaultEnhanced() {
     if (!Services.prefs.prefHasUserValue(PREF_NEWTAB_ENHANCED)) {
-      let enhanced = true;
+      let enhanced = Services.prefs.getBoolPref(PREF_NEWTAB_ENHANCED);
       try {
         // Default to not enhanced if DNT is set to tell websites to not track
         if (Services.prefs.getBoolPref("privacy.donottrackheader.enabled")) {
