From: Mike Hommey <mh@glandium.org>
Date: Tue, 9 Mar 2010 09:44:37 +0100
Subject: Allow to build against system libffi

https://bugzilla.mozilla.org/show_bug.cgi?id=551138
---
 js/src/Makefile.in           |   16 ++++++++++++++--
 js/src/config/autoconf.mk.in |    4 ++++
 js/src/configure.in          |   14 +++++++++++++-
 js/src/shell/Makefile.in     |    3 +++
 4 files changed, 34 insertions(+), 3 deletions(-)

diff --git a/js/src/Makefile.in b/js/src/Makefile.in
index efecd10..71b7456 100644
--- a/js/src/Makefile.in
+++ b/js/src/Makefile.in
@@ -490,11 +490,20 @@ CPPSRCS += \
     Library.cpp \
     $(NULL)
 
-LOCAL_INCLUDES = \
-    -Ictypes/libffi/include \
+ifdef MOZ_NATIVE_FFI
+LOCAL_INCLUDES = $(MOZ_FFI_CFLAGS)
+else
+LOCAL_INCLUDES = -Ictypes/libffi/include
+endif
+
+LOCAL_INCLUDES += \
     -I. \
     $(NULL)
 
+
+ifdef MOZ_NATIVE_FFI
+EXTRA_DSO_LDOPTS += $(MOZ_FFI_LIBS)
+else
 ifeq ($(OS_ARCH),OS2)
 SHARED_LIBRARY_LIBS += \
     ctypes/libffi/.libs/ffi.a \
@@ -504,6 +513,7 @@ SHARED_LIBRARY_LIBS += \
     ctypes/libffi/.libs/libffi.$(LIB_SUFFIX) \
     $(NULL)
 endif
+endif
 
 endif # JS_HAS_CTYPES
 
@@ -583,6 +593,7 @@ endif
 include $(topsrcdir)/config/rules.mk
 
 ifdef JS_HAS_CTYPES
+ifndef MOZ_NATIVE_FFI
 # Build libffi proper as part of the 'exports' target, so things get built
 # in the right order.
 export::
@@ -591,6 +602,7 @@ export::
 distclean clean::
 		$(call SUBMAKE,$@,ctypes/libffi)
 endif
+endif
 
 # Because the SpiderMonkey can be distributed and built independently
 # of the Mozilla source tree, it contains its own copies of many of
diff --git a/js/src/config/autoconf.mk.in b/js/src/config/autoconf.mk.in
index 7f14a6b..ab24db0 100644
--- a/js/src/config/autoconf.mk.in
+++ b/js/src/config/autoconf.mk.in
@@ -246,6 +246,10 @@ NSPR_CONFIG	= @NSPR_CONFIG@
 NSPR_CFLAGS	= @NSPR_CFLAGS@
 NSPR_LIBS	= @NSPR_LIBS@
 
+MOZ_NATIVE_FFI	= @MOZ_NATIVE_FFI@
+MOZ_FFI_LIBS	= @MOZ_FFI_LIBS@
+MOZ_FFI_CFLAGS	= @MOZ_FFI_CFLAGS@
+
 USE_DEPENDENT_LIBS = @USE_DEPENDENT_LIBS@
 
 JS_NATIVE_EDITLINE = @JS_NATIVE_EDITLINE@
diff --git a/js/src/configure.in b/js/src/configure.in
index 361d029..872b320 100644
--- a/js/src/configure.in
+++ b/js/src/configure.in
@@ -4355,6 +4355,18 @@ if test -n "$MOZ_NATIVE_NSPR"; then
     CFLAGS=$_SAVE_CFLAGS
 fi
 
+dnl system libffi Support
+dnl ========================================================
+MOZ_ARG_ENABLE_BOOL(system-ffi,
+[  --enable-system-ffi       Use system libffi (located with pkgconfig)],
+    MOZ_NATIVE_FFI=1 )
+
+if test -n "$MOZ_NATIVE_FFI"; then
+    PKG_CHECK_MODULES(MOZ_FFI, libffi)
+fi
+
+AC_SUBST(MOZ_NATIVE_FFI)
+
 dnl ========================================================
 dnl =
 dnl = Application
@@ -5935,7 +5947,7 @@ AC_MSG_RESULT(invoking make to create js-config script)
 $GMAKE js-config
 
 # Build jsctypes if it's enabled.
-if test "$JS_HAS_CTYPES"; then
+if test "$JS_HAS_CTYPES" -a -z "$MOZ_NATIVE_FFI"; then
   # Run the libffi 'configure' script.
   ac_configure_args="--disable-shared --enable-static --disable-raw-api"
   if test "$MOZ_DEBUG"; then
diff --git a/js/src/shell/Makefile.in b/js/src/shell/Makefile.in
index 8a4f8cf..a9eb875 100644
--- a/js/src/shell/Makefile.in
+++ b/js/src/shell/Makefile.in
@@ -53,6 +53,9 @@ CPPSRCS		= \
 DEFINES         += -DEXPORT_JS_API
 
 LIBS      = $(NSPR_LIBS) $(EDITLINE_LIBS) $(DEPTH)/$(LIB_PREFIX)js_static.$(LIB_SUFFIX)
+ifdef MOZ_NATIVE_FFI
+EXTRA_LIBS += $(MOZ_FFI_LIBS)
+endif
 
 LOCAL_INCLUDES += -I$(topsrcdir) -I..
 
